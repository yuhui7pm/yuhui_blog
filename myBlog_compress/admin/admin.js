var path;var username;var arr;var index;var items=10;var itemsInPage=new Array();var num=0;var pageNumber=1;var pageOfComments=1;var page;var pageCom;var createtime;var titleUpdated;var contentUpdated;var userCommentsArr;let _last;var changedState=true;var blogsPagination;var commentsPagination;var commentsArr;var newArr=[];window.onload=()=>{if(window.location.href.split('?')[1]){path=window.location.href.split('?')[1];username=path.split('=')[1];username=username.replace('#','');$('.username').html('用户：'+username)};getLists(username);toggleClick()}function getLists(username){$.ajax({url:"/api/blog/personalLists",type:"GET",dataType:"json",contentType:"application/json",data:{username:username},success:(result)=>{arr=result.data;arr.forEach(item=>{itemsInPage.push(item)})addInForm(itemsInPage,pageNumber);pages(itemsInPage);buttonChangePage(itemsInPage)}})}function buttonChangePage(arr){$('.arrowForward').click(()=>{if(pageNumber>1){$('.blogLists').empty();addInForm(itemsInPage,pageNumber-1);pageNumber--;return}})$('.arrowBackWard').click(()=>{if(pageNumber<page){$('.blogLists').empty();addInForm(itemsInPage,pageNumber+1);pageNumber++;return}})}function addInForm(arr,pageNumber){var Remainder=Math.min(items*pageNumber,arr.length);for(var i=items*(pageNumber-1);i<Remainder;i++){var timeChanged=dataFormat(itemsInPage[i].createtime);$('.blogLists').append(`<tr><td style="width: 5%;">${i+1}</td><td style="width: 10%;">${itemsInPage[i].title}</td><td style="width: 70%;">${itemsInPage[i].introduction}</td><td style="width: 5%;">${timeChanged}</td><td style="width: 5%;"class="updateBlog"onclick="blogEdit(itemsInPage[${i}].title,itemsInPage[${i}].introduction,itemsInPage[${i}].content,${itemsInPage[i].createtime})"><a>修改</a></td><td style="width: 5%;"class="deleteBlog"onclick="deleteBlog(${itemsInPage[i].createtime},${itemsInPage[i].id})"><a>删除</a></td></tr>`)}}function pages(arr){var blogsLen=arr.length;page=Math.ceil(blogsLen/10);for(var j=0;j<page;j++){$('.arrowBackWard').before(`<li class="pageNum"onclick="$('.blogLists').empty();addInForm(arr,${j+1});pageNumber=${j+1}"><a>${j+1}</a></li>`)}}function deleteBlog(createtime,id){$.ajax({url:"/api/blog/delete",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({createtime:String(createtime),id}),success:(res)=>{if(res.errNum==0){$('.panel').empty();$('.blogLists').empty();itemsInPage=[];blogsManage();getLists(username);$('.pages').show();$('.pageNum').remove()}else{console.error("删除出错")}}})}function blogEdit(title,introduction,content,time){var panel=$('.panel').detach();var pages=$('.pages').detach();var breadcrumb=$('.breadcrumb').detach();$('.adminContentWrapper').append(`<ol class="breadcrumb"><li><a href="./index.html">首页</a></li><li><a href="./admin.html?username=${username}">后台管理</a></li><li class="active">${title}</li></ol><div class="contentEdit"><form role="form"style="width:100%"><div class="form-group"style="width:100%"><label>简介</label><span style="visibility:hidden;"class="createtime">${time}</span><textarea class="form-control blogTitleUpdate"rows="5"style="width:820px">${introduction}</textarea></div><div class="form-group"style="width:100%"><label>正文</label><!--富文本编辑器--><div id="summernote"style="width:100%;margin:0;padding:0"></div></div></form><button type="button"class="btn btn-lg submitButton"onclick="updateBlog()">提交</button></div>`)$('#summernote').summernote({placeholder:'请输入公告内容',height:400,width:820});$('#summernote').summernote('code',content);$('.blogTitleUpdate').bind("input propertychange",function(){titleUpdated=$('.blogTitleUpdate').val()});$('.blogContentUpdate').bind("input propertychange",function(event){contentUpdated=$('.blogContentUpdate').val()})}function updateBlog(){introductionUpdated=$('.blogTitleUpdate').val();createtime=$('.createtime').html();contentUpdated=$('#summernote').summernote('code');$.ajax({url:"/api/blog/update",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({username:getUsername(),createtime:String(createtime),introductionUpdated,contentUpdated}),success:(res)=>{if(res.errNum==0){window.location.reload()}else{console.error("删除出错")}}})}function articleManageClick(){$('.articleManage').click(()=>{const _this=event.currentTarget;$(_this).css('color','orangered');$('.commentManage').css('color','#337AB7');$('.panel').empty();$('.blogLists').empty();itemsInPage=[];blogsManage();getLists(username);$('.pages').show();$('.pageNum').remove()})}function getAllComments(){$.ajax({url:"/api/blogs/getAllComments",type:"GET",dataType:"json",contentType:"application/json",data:{username},success:(result)=>{commentsArr=result.data;if(result.errNum==0){commentsArr.map((value,index,arr)=>{newArr.push({'index':index+1,'type':'1','commentId':value.id,'blogId':value.blogid,'title':value.title,'content':value.firstcontext,'time':value.firstcommenttime})})getSecondComments()}}})}function getSecondComments(){$.ajax({url:"/api/blogs/getAllSecondComments",type:"GET",dataType:"json",contentType:"application/json",data:{username},success:(result)=>{var secondCommentsLists=result.data;if(result.errNum==0){if(secondCommentsLists){secondCommentsLists.map((value,index,arr)=>{newArr.push({'index':commentsArr.length+index+1,'type':'2','commentId':value.id,'blogId':value.blogId,'title':value.title,'content':value.secondCommentContext,'time':value.secondCommentCreatetime})})newArr.sort((a,b)=>{return b.time>a.time?1:-1})}addCommentInForm(newArr,pageOfComments);pagesComments(newArr);buttonChangePage2(newArr)}}})}function addCommentInForm(newArr,pageOfComments){var Remainder=Math.min(items*pageOfComments,newArr.length);for(var i=items*(pageOfComments-1);i<Remainder;i++){var timeChanged=dataFormat(newArr[i].createtime);$('.blogLists').append(`<tr><td style="width: 5%;">${i+1}</td><td style="width: 10%;">${newArr[i].title}</td><td style="width: 70%;">${AnalyticEmotion(newArr[i].content)}</td><td style="width: 5%;">${dataFormat(newArr[i].time)}</td><td style="width: 5%;"class="updateBlog"onclick="goBackBlog(${newArr[i].blogId})"><a>查看原文</a></td><td style="width: 5%;"class="deleteBlog"onclick="deleteComments(${newArr[i].type},${newArr[i].commentId},getUsername())"><a>删除</a></td></tr>`)}}function pagesComments(newArr){var blogsLen=newArr.length;pageCom=Math.ceil(blogsLen/10);for(var j=0;j<pageCom;j++){$('.arrowBackWard').before(`<li class="pageNum"onclick="$('.blogLists').empty();addCommentInForm(newArr,${j+1});pageOfComments=${j+1}"><a>${j+1}</a></li>`)}}function buttonChangePage2(newArr){$('.arrowForward').click(()=>{if(pageOfComments>1){$('.blogLists').empty();addCommentInForm(newArr,pageOfComments-1);pageOfComments--;return}})$('.arrowBackWard').click(()=>{if(pageOfComments<pageCom){$('.blogLists').empty();addCommentInForm(newArr,pageOfComments+1)pageOfComments++;return}})}function commentsLists(){$('.panel').append(`<!--Default panel contents--><div class="panel-heading"style="font-weight: bold;">用户评论管理</div><!--斑马表格--><table class="table table-striped"style='table-layout:fixed;'><!--table-layout列宽由表格宽度和列宽度设定。--><thead><tr><td>id</td><td>被评论的博客</td><td>评论内容</td><td>评论时间</td><td colspan="2">操作</td></tr></thead><tbody class="blogLists"></tbody></table>`)}function blogsManage(){$('.panel').append(`<!--Default panel contents--><div class="panel-heading"style="font-weight: bold;">博客文章管理</div><!--斑马表格--><table class="table table-striped"style='table-layout:fixed;'><!--table-layout列宽由表格宽度和列宽度设定。--><thead><tr><td>id</td><td>文章标题</td><td>文章简介</td><td>创建时间</td><td colspan="2">操作</td></tr></thead><tbody class="blogLists"></tbody></table>`)}function goBackBlog(blogId){window.parent.location.href="./blogDetail.html?username="+getUsername()+"&blogId="+blogId}function deleteComments(type,commentId,user){console.log(type,commentId,user)$.ajax({url:"/api/blog/deleteComments",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({type,commentId,user}),success:(res)=>{if(res.errNum==0){$('.panel').empty();$('.blogLists').empty();newArr=[];commentsLists();getAllComments(username);$('.pageNum').remove()}}})}function commentManageClick(){$('.commentManage').click(()=>{const _this=event.currentTarget;$(_this).css('color','orangered');$('.articleManage').css('color','#337AB7');$('.panel').empty();$('.blogLists').empty();newArr=[];commentsLists();getAllComments(username);$('.pageNum').remove()})}function getUsername(){if(window.location.href.split('?username=').length>1){var user=window.location.href.split('?username=')[1].split('&')[0];return user}else{return false}}function toggleClick(){articleManageClick();commentManageClick()}function dataFormat(time){var timeStr=new Date(time);var year=timeStr.getFullYear(),month=timeStr.getMonth()+1,day=timeStr.getDate(),hour=timeStr.getHours(),minute=timeStr.getMinutes(),second=timeStr.getSeconds();return year+'-'+addZero(month)+'-'+addZero(day)+'  '+addZero(hour)+':'+addZero(minute)+':'+addZero(second)}function addZero(data){return data<10?'0'+data:data}